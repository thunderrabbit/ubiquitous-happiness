#!/bin/bash

# TODO: make AWS_REGION be specified by user when setup.sh is run
AWS_REGION=us-west-1

AWS_ANSIBLE_DIRECTORY=$HOME/ansible

if [ ! -d $AWS_ANSIBLE_DIRECTORY ];
then
    mkdir $AWS_ANSIBLE_DIRECTORY
fi

if [ ! -f $AWS_ANSIBLE_DIRECTORY/ec2.ini ];
then
    cd $AWS_ANSIBLE_DIRECTORY
    curl https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/ec2.ini > ec2.ini
    curl https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/ec2.py > ec2.py
    chmod 755 ec2.py

    ## git all the things
    git init
    git add ec2.py ec2.ini
    git commit -m "Initial versions of ec2.py and ec2.ini

    as pulled from
    curl https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/ec2.py > ec2.py
    curl https://raw.githubusercontent.com/ansible/ansible/devel/contrib/inventory/ec2.ini > ec2.ini"

    # Focus on only one region, which makes things much faster.
    sed -i "s/regions = all/regions = $AWS_REGION/" ec2.ini

    git add ec2.ini
    git commit -m "Speed up requests by targeting just one region."


    # http://alexconst.net/2016/02/08/ansible/
    sed -i "s/#rds = False/rds = False/" ec2.ini
    sed -i "s/#elasticache = False/elasticache = False/" ec2.ini

    git add ec2.ini
    git commit -m "Only look for EC2 instances, not RDS nor elasticache"
fi

